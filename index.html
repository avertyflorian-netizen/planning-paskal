<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning de lecture ‚Äì Paskal</title>
  <style>
    :root {
      --bg: #050509;
      --bg-soft: #101018;
      --bg-softer: #181824;
      --accent: #e63971;
      --accent-soft: rgba(230, 57, 113, 0.2);
      --text: #f7f7ff;
      --text-muted: #b4b4d0;
      --border: #26263a;
      --danger: #ff5577;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
      --radius-lg: 18px;
      --radius-xl: 26px;
      --transition: 0.2s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1b1220 0, #050509 55%);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 16px 64px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      padding: 24px 24px 32px;
      backdrop-filter: blur(20px);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .title-block {
      max-width: 520px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.highlight {
      background: linear-gradient(120deg, #e63971, #7f5dff);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      object-fit: cover;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.7);
    }

    .social {
      font-size: 0.9rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .social a {
      color: var(--accent);
      text-decoration: none;
    }

    .social a:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 0.78rem;
      margin-top: 8px;
      color: var(--text-muted);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(230, 57, 113, 0.7);
    }

    .mode-badge {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-align: right;
    }
    .mode-badge span {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .public-notice {
      display: none;
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.35);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .public-notice strong {
      color: var(--accent);
    }

    /* Counters */

    .counters {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.05), rgba(5, 5, 9, 0.9));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.07);
      padding: 12px 14px;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(230, 57, 113, 0.08), transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }

    .card-title {
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .card-value {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .card-detail {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Section titles */

    .section-title {
      font-size: 1.05rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.bar {
      width: 40px;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e63971, #7f5dff);
    }

    /* Form */

    .form-card {
      background: var(--bg-soft);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px;
      margin-bottom: 24px;
    }

    form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.82rem;
    }

    label {
      color: var(--text-muted);
    }

    input, select {
      background: var(--bg-softer);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 11px;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(230, 57, 113, 0.35);
      background: #1e1e2b;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 0.88rem;
      font-weight: 600;
      background: linear-gradient(120deg, #e63971, #7f5dff);
      color: #fff;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), filter var(--transition);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.65);
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.75);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 5px 16px rgba(0, 0, 0, 0.7);
    }

    .button-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: none;
      padding-inline: 10px;
      font-size: 0.78rem;
    }

    .button-danger {
      background: transparent;
      border: 1px solid rgba(255, 85, 119, 0.6);
      color: var(--danger);
      box-shadow: none;
      padding-inline: 10px;
      font-size: 0.78rem;
    }

    .helper-text {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 12px;
      height: 6px;
      border-radius: 999px;
    }

    .legend-reading {
      background: rgba(255, 255, 255, 0.2);
    }

    .legend-processing {
      background: rgba(255, 255, 255, 0.06);
      border: 1px dashed rgba(255, 255, 255, 0.16);
    }

    /* Summary bar */

    .summary-card {
      background: var(--bg-soft);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 16px;
      margin-bottom: 18px;
    }

    .summary-bar {
      position: relative;
      width: 100%;
      border-radius: 999px;
      background: radial-gradient(circle at center, rgba(255,255,255,0.06), rgba(0,0,0,0.7));
      border: 1px solid rgba(255,255,255,0.12);
      overflow: hidden;
      display: flex;
      height: 22px;
    }

    .summary-segment {
      cursor: pointer;
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      padding-inline: 6px;
      transition: filter 0.15s ease-out, transform 0.15s ease-out;
    }

    .summary-segment:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .summary-caption {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Timeline / books */

    .timeline-card {
      background: var(--bg-soft);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px;
    }

    .books-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
      max-height: 540px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .book-row {
      background: radial-gradient(circle at left, rgba(230, 57, 113, 0.1), transparent 60%);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 8px 10px 6px;
    }

    .book-header {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 6px;
      align-items: center;
      cursor: pointer;
    }

    .book-main-line {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .book-title {
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .genre-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(255, 255, 255, 0.35);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }

    .book-header-right {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-pill {
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-upcoming {
      background: rgba(255, 255, 255, 0.03);
      border: 1px dashed rgba(255, 255, 255, 0.13);
    }
    .status-reading {
      background: rgba(126, 210, 255, 0.12);
      border: 1px solid rgba(126, 210, 255, 0.35);
      color: #b9e3ff;
    }
    .status-processing {
      background: rgba(255, 201, 99, 0.15);
      border: 1px solid rgba(255, 201, 99, 0.5);
      color: #ffe3aa;
    }
    .status-done {
      background: rgba(119, 223, 169, 0.13);
      border: 1px solid rgba(119, 223, 169, 0.45);
      color: #b4f0cf;
    }

    .short-dates {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .toggle-icon {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .book-body {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      display: none;
      gap: 10px;
    }
    .book-row.open .book-body {
      display: block;
    }

    .book-meta {
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    .book-dates {
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }
    .book-dates span { white-space: nowrap; }

    .book-extra {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }

    .timeline-bar-wrap {
      position: relative;
      padding: 5px 0 3px;
    }

    .timeline-bar-bg {
      position: relative;
      min-height: 22px;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.6));
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 1px;
      max-width: 100%;
    }

    .segments {
      position: relative;
      display: flex;
      align-items: stretch;
      height: 18px;
    }

    .segment-reading,
    .segment-processing {
      height: 100%;
      border-radius: 999px;
      transition: transform 0.15s ease-out;
    }
    .segment-processing {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.5));
      border: 1px dashed rgba(255, 255, 255, 0.2);
      box-sizing: border-box;
    }

    .timeline-bar-wrap:hover .segment-reading,
    .timeline-bar-wrap:hover .segment-processing {
      transform: translateY(-1px);
    }

    .day-markers {
      margin-top: 3px;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .edit-dates {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      align-items: center;
      font-size: 0.76rem;
    }

    .edit-dates-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .edit-dates label {
      font-size: 0.74rem;
    }

    .edit-dates input[type="date"] {
      border-radius: 999px;
      background: #181824;
      border-color: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      font-size: 0.76rem;
    }

    .edit-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
      padding: 16px 6px 6px;
    }

    @media (max-width: 900px) {
      .app { padding: 18px 14px 26px; }
      header { flex-direction: column; align-items: flex-start; }
      form { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .counters { grid-template-columns: 1fr; }
      .book-header { grid-template-columns: minmax(0, 1fr); }
      .profile { align-self: flex-start; }
    }

    @media (max-width: 600px) {
      form { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>
          <span class="highlight">Planning de lecture</span> ‚Äì Paskal
        </h1>
        <p class="subtitle">
          Visualisation dynamique du temps de lecture & de traitement des services presse
          (dark romance, romantasy & co).
        </p>
        <div class="pill">
          <span class="dot"></span>
          Charge de lecture actuelle en temps quasi r√©el
        </div>
      </div>
      <div class="profile">
        <img
          class="avatar"
          src="https://scontent-mrs2-2.cdninstagram.com/v/t51.2885-19/580981411_17907582135259686_3323642431245047816_n.jpg?stp=dst-jpg_s150x150_tt6&efg=eyJ2ZW5jb2RlX3RhZyI6InByb2ZpbGVfcGljLmRqYW5nby44NDMuYzIifQ&_nc_ht=scontent-mrs2-2.cdninstagram.com&_nc_cat=106&_nc_oc=Q6cZ2QFX6r0ROuKwc1Kt9KVCCs_M2zfil6tZJMtumFtWMJyUU3uodqVChAlL1LcecyE67rI&_nc_ohc=g-5Nix2j8f8Q7kNvwFyX1OX&_nc_gid=L3clKEgTXdZZ6yrwz8OL5A&edm=AEYEu-QBAAAA&ccb=7-5&oh=00_AfnXr1g_7AmIv59Lno5GVi3bSVzdXtqc27kwDC2atf5tig&oe=69375513&_nc_sid=ead929"
          alt="Photo de Paskal"
        />
        <div class="social">
          <div><strong>Paskal</strong> ‚Äì critique litt√©raire moderne</div>
          <div>Instagram : <a href="https://instagram.com/paskaldprs2" target="_blank">@paskaldprs2</a></div>
          <div>TikTok : <a href="https://www.tiktok.com/@paskaldprs2" target="_blank">@paskaldprs2</a></div>
        </div>
      </div>
    </header>

    <div class="mode-badge" id="mode-badge"></div>

    <div class="public-notice" id="public-notice">
      <strong>Note :</strong> ce planning est indicatif. Les dates de lecture et de traitement peuvent √©voluer en fonction de ma charge,
      de mes contraintes personnelles et de mes coups de c≈ìur. Merci pour votre compr√©hension üñ§
    </div>

    <!-- Compteurs -->
    <section class="counters">
      <div class="card">
        <div class="card-title">Livres en cours de lecture</div>
        <div class="card-value" id="count-in-progress">0</div>
        <div class="card-detail">Lecture active aujourd'hui</div>
      </div>
      <div class="card">
        <div class="card-title">Livres lus ce mois-ci</div>
        <div class="card-value" id="count-month">0</div>
        <div class="card-detail">Fin de lecture dans le mois en cours</div>
      </div>
      <div class="card">
        <div class="card-title">Livres lus cette ann√©e</div>
        <div class="card-value" id="count-year">0</div>
        <div class="card-detail">Fin de lecture depuis le 1er janvier</div>
      </div>
    </section>

    <!-- Formulaire d'ajout -->
    <section id="admin-form-section">
      <div class="section-title">
        <span>Ajouter un ouvrage au planning</span>
        <span class="bar"></span>
      </div>
      <div class="form-card">
        <form id="book-form">
          <div class="field">
            <label for="title">Titre du livre</label>
            <input id="title" type="text" placeholder="Titre ou code SP" required />
          </div>
          <div class="field">
            <label for="pages">Nombre de pages</label>
            <input id="pages" type="number" min="1" placeholder="ex : 420" required />
          </div>
          <div class="field">
            <label for="genre">Genre / sous-genre</label>
            <select id="genre" required>
              <option value="dark_romance">Dark romance</option>
              <option value="mafia_romance">Mafia romance</option>
              <option value="psychological_romance">Romance psychologique / toxique</option>
              <option value="romantasy">Romantasy</option>
              <option value="paranormal_romance">Romance paranormale</option>
              <option value="gothic_romance">Gothic / occult romance</option>
              <option value="contemporary_angsty">Romance contemporaine sombre</option>
              <option value="historical_dark">Romance historique sombre</option>
              <option value="taboo_romance">Taboo / forbidden romance</option>
              <option value="reverse_harem">Reverse harem / why choose</option>
              <option value="other">Autre romance sombre</option>
            </select>
          </div>
          <div class="field">
            <label for="receivedDate">Date de r√©ception</label>
            <input id="receivedDate" type="date" required />
          </div>
          <div class="field">
            <label for="startDate">D√©but de lecture (pr√©vu)</label>
            <input id="startDate" type="date" required />
          </div>
          <div class="field">
            <button type="submit">Ajouter au planning</button>
          </div>
        </form>

        <div style="margin-top: 10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button type="button" id="export-html-btn" class="button-ghost">
            Exporter la version GitHub (index.html)
          </button>
          <button type="button" id="copy-public-url-btn" class="button-ghost">
            Copier l‚ÄôURL publique
          </button>
          <div class="helper-text">
            T√©l√©charge un fichier <strong>index.html</strong> avec l'√©tat actuel du planning, puis mets-le sur GitHub.
            Le bouton copie aussi l‚ÄôURL publique en mode lecture seule.
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <span class="legend-color legend-reading"></span> Segment color√© : temps de <strong>lecture</strong>
          </div>
          <div class="legend-item">
            <span class="legend-color legend-processing"></span> Segment clair : temps de <strong>traitement</strong> (chronique, posts‚Ä¶)
          </div>
          <div class="legend-item">
            1 ‚Äúbulle‚Äù horizontale ‚âà <strong>1 jour</strong>
          </div>
        </div>
      </div>
    </section>

    <!-- Graphique synth√©tique -->
    <section>
      <div class="section-title">
        <span>Vue synth√©tique de la charge</span>
        <span class="bar"></span>
      </div>
      <div class="summary-card">
        <div id="summary-bar" class="summary-bar"></div>
        <div class="summary-caption">
          <span>Chaque segment = 1 livre (lecture + traitement cumul√©s)</span>
          <span>Clic sur un segment ‚Üí ouvre le d√©tail plus bas</span>
        </div>
      </div>
    </section>

    <!-- Timeline d√©taill√©e -->
    <section>
      <div class="section-title">
        <span>D√©tail par ouvrage</span>
        <span class="bar"></span>
      </div>
      <div class="timeline-card">
        <div id="books-container" class="books-list">
          <div class="empty-state">
            Aucun livre dans le planning pour le moment.
            Ajoute un ouvrage via le formulaire ci-dessus pour voir la timeline se construire.
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----- CONFIG -----
    const GENRE_COLORS = {
      dark_romance: "#e63971",
      mafia_romance: "#ff914d",
      psychological_romance: "#ff4d6d",
      romantasy: "#7f5dff",
      paranormal_romance: "#5bd1ff",
      gothic_romance: "#9b5de5",
      contemporary_angsty: "#ff758f",
      historical_dark: "#f4b942",
      taboo_romance: "#ff4fa3",
      reverse_harem: "#00c896",
      other: "#b3b3ff"
    };

    const DAY_PIXEL_WIDTH = 22;
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;

    const urlParams = new URLSearchParams(window.location.search);
    const isPublicMode = urlParams.get("mode") === "public";

    // Ce sera remplac√© par les donn√©es export√©es quand tu cliques sur le bouton d‚Äôexport
    const EMBEDDED_DATA = null;

    let books = [];
    let nextId = 1;

    // ----- UTILS DATES -----
    function parseDateInput(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      return new Date(year, month - 1, day);
    }

    function formatDate(date) {
      if (!date) return "";
      return date.toLocaleDateString("fr-FR", { day: "2-digit", month: "2-digit", year: "numeric" });
    }

    function formatDateForInput(date) {
      if (!date) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }

    function addDays(date, days) {
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + days);
      return d;
    }

    function diffDaysInclusive(start, end) {
      const diff = Math.round((end - start) / ONE_DAY_MS);
      return Math.max(1, diff + 1);
    }

    function computeDurationsFromPages(pages) {
      pages = Number(pages);
      let readingDays;
      let processingDays;

      if (pages < 300) {
        readingDays = 2;
        processingDays = 1;
      } else if (pages < 500) {
        readingDays = 5;
        processingDays = 2;
      } else if (pages < 700) {
        readingDays = 7;
        processingDays = 2;
      } else if (pages < 900) {
        readingDays = 9;
        processingDays = 3;
      } else {
        const extraBlocks = Math.floor((pages - 900) / 200) + 1;
        readingDays = 9 + 2 * extraBlocks;
        processingDays = 3;
      }

      return { readingDays, processingDays };
    }

    function computeDurationsFromDates(book) {
      const readingDays = diffDaysInclusive(book.startDate, book.endReading);
      const totalDays = diffDaysInclusive(book.startDate, book.endProcessing);
      const processingDays = Math.max(0, totalDays - readingDays);
      return { readingDays, processingDays, totalDays };
    }

    function getStatus(today, start, endReading, endProcessing) {
      if (today < start) return "upcoming";
      if (today >= start && today <= endReading) return "reading";
      if (today > endReading && today <= endProcessing) return "processing";
      return "done";
    }

    // Hydratation depuis EMBEDDED_DATA (export)
    function hydrateInitialBooks(rawBooks) {
      rawBooks.forEach((rb) => {
        books.push({
          id: nextId++,
          title: rb.title,
          pages: rb.pages,
          genre: rb.genre,
          genreLabel: rb.genreLabel,
          receivedDate: new Date(rb.receivedDate),
          startDate: new Date(rb.startDate),
          endReading: new Date(rb.endReading),
          endProcessing: new Date(rb.endProcessing)
        });
      });
    }

    // ----- COMPTEURS -----
    function updateCounters() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      let inProgress = 0;
      let finishedThisMonth = 0;
      let finishedThisYear = 0;

      books.forEach((b) => {
        const { endReading } = b;
        const status = getStatus(today, b.startDate, b.endReading, b.endProcessing);

        if (status === "reading") inProgress++;

        if (endReading.getFullYear() === currentYear) {
          finishedThisYear++;
          if (endReading.getMonth() === currentMonth) {
            finishedThisMonth++;
          }
        }
      });

      document.getElementById("count-in-progress").textContent = inProgress;
      document.getElementById("count-month").textContent = finishedThisMonth;
      document.getElementById("count-year").textContent = finishedThisYear;
    }

    // ----- GRAPHIQUE SYNTHETIQUE -----
    function renderSummaryBar() {
      const summaryBar = document.getElementById("summary-bar");
      summaryBar.innerHTML = "";

      if (!books.length) {
        return;
      }

      const sorted = books.slice().sort((a, b) => a.startDate - b.startDate);
      const durations = sorted.map((b) => computeDurationsFromDates(b));
      const totalDaysAll = durations.reduce((acc, d) => acc + d.totalDays, 0);

      sorted.forEach((book, index) => {
        const info = durations[index];
        const widthPercent = (info.totalDays / totalDaysAll) * 100;

        const seg = document.createElement("div");
        seg.className = "summary-segment";
        seg.style.width = widthPercent + "%";

        const color = GENRE_COLORS[book.genre] || GENRE_COLORS.other;
        seg.style.background = "linear-gradient(135deg, " + color + ", " + color + "aa)";

        const label = book.title.length > 16 ? book.title.slice(0, 14) + "‚Ä¶" : book.title;
        seg.textContent = label;
        seg.title = book.title + " ‚Ä¢ " + info.totalDays + " j (lecture + traitement)";

        seg.addEventListener("click", function () {
          const row = document.querySelector('.book-row[data-id="' + book.id + '"]');
          if (row) {
            row.classList.add("open");
            row.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        });

        summaryBar.appendChild(seg);
      });
    }

    // ----- RENDU DETAILLE -----
    function renderBooks() {
      const container = document.getElementById("books-container");
      container.innerHTML = "";

      if (!books.length) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent =
          "Aucun livre dans le planning pour le moment. Ajoute un ouvrage via le formulaire ci-dessus pour voir la timeline se construire.";
        container.appendChild(div);
        updateCounters();
        renderSummaryBar();
        return;
      }

      const today = new Date();
      const sorted = books.slice().sort((a, b) => a.startDate - b.startDate);

      sorted.forEach((book) => {
        const durations = computeDurationsFromDates(book);
        const status = getStatus(today, book.startDate, book.endReading, book.endProcessing);
        const color = GENRE_COLORS[book.genre] || GENRE_COLORS.other;

        const row = document.createElement("div");
        row.className = "book-row";
        row.dataset.id = book.id;

        // HEADER
        const header = document.createElement("div");
        header.className = "book-header";

        const headerLeft = document.createElement("div");
        headerLeft.className = "book-main-line";

        const titleDiv = document.createElement("div");
        titleDiv.className = "book-title";
        titleDiv.textContent = book.title;

        const genreBadge = document.createElement("div");
        genreBadge.className = "genre-badge";
        genreBadge.style.borderColor = color;
        genreBadge.style.color = color;
        genreBadge.textContent = book.genreLabel;

        headerLeft.appendChild(titleDiv);
        headerLeft.appendChild(genreBadge);

        const headerRight = document.createElement("div");
        headerRight.className = "book-header-right";

        const shortDates = document.createElement("div");
        shortDates.className = "short-dates";
        shortDates.textContent = formatDate(book.startDate) + " ‚Üí " + formatDate(book.endProcessing);

        const statusSpan = document.createElement("span");
        statusSpan.className = "status-pill";
        if (status === "upcoming") {
          statusSpan.classList.add("status-upcoming");
          statusSpan.textContent = "√Ä venir";
        } else if (status === "reading") {
          statusSpan.classList.add("status-reading");
          statusSpan.textContent = "Lecture en cours";
        } else if (status === "processing") {
          statusSpan.classList.add("status-processing");
          statusSpan.textContent = "Traitement";
        } else {
          statusSpan.classList.add("status-done");
          statusSpan.textContent = "Termin√©";
        }

        const toggleIcon = document.createElement("span");
        toggleIcon.className = "toggle-icon";
        toggleIcon.textContent = "‚ñº";

        headerRight.appendChild(shortDates);
        headerRight.appendChild(statusSpan);
        headerRight.appendChild(toggleIcon);

        header.appendChild(headerLeft);
        header.appendChild(headerRight);

        header.addEventListener("click", function () {
          row.classList.toggle("open");
        });

        // BODY
        const body = document.createElement("div");
        body.className = "book-body";

        const meta = document.createElement("div");
        meta.className = "book-meta";

        const datesDiv = document.createElement("div");
        datesDiv.className = "book-dates";
        datesDiv.innerHTML =
          '<span>R√©ception : <strong>' + formatDate(book.receivedDate) + '</strong></span>' +
          '<span>D√©but lecture : <strong>' + formatDate(book.startDate) + '</strong></span>' +
          '<span>Fin lecture : <strong>' + formatDate(book.endReading) + '</strong></span>' +
          '<span>Fin traitement : <strong>' + formatDate(book.endProcessing) + '</strong></span>';

        const extra = document.createElement("div");
        extra.className = "book-extra";
        extra.innerHTML =
          '<span>' + book.pages + ' pages</span>' +
          '<span>' + durations.readingDays + ' j lecture + ' + durations.processingDays + ' j traitement</span>' +
          '<span>' + durations.totalDays + ' j cumul√©s</span>';

        meta.appendChild(datesDiv);
        meta.appendChild(extra);

        // BARRE
        const timelineWrap = document.createElement("div");
        timelineWrap.className = "timeline-bar-wrap";

        const barBg = document.createElement("div");
        barBg.className = "timeline-bar-bg";

        const segments = document.createElement("div");
        segments.className = "segments";

        const totalWidth = durations.totalDays * DAY_PIXEL_WIDTH;
        const readingWidth = durations.readingDays * DAY_PIXEL_WIDTH;
        const processingWidth = durations.processingDays * DAY_PIXEL_WIDTH;

        segments.style.width = totalWidth + "px";

        const readingSeg = document.createElement("div");
        readingSeg.className = "segment-reading";
        readingSeg.style.width = readingWidth + "px";
        readingSeg.style.background = "linear-gradient(135deg, " + color + ", " + color + "aa)";

        const processingSeg = document.createElement("div");
        processingSeg.className = "segment-processing";
        processingSeg.style.width = processingWidth + "px";

        segments.appendChild(readingSeg);
        segments.appendChild(processingSeg);
        barBg.appendChild(segments);

        const markers = document.createElement("div");
        markers.className = "day-markers";
        markers.innerHTML =
          '<span>Jour 0</span>' +
          '<span>' + durations.totalDays + ' j au total</span>';

        timelineWrap.appendChild(barBg);
        timelineWrap.appendChild(markers);

        body.appendChild(meta);
        body.appendChild(timelineWrap);

        // EDIT DATES
        const editDates = document.createElement("div");
        editDates.className = "edit-dates";

        const groupStart = document.createElement("div");
        groupStart.className = "edit-dates-group";
        groupStart.innerHTML =
          '<label>D√©but</label>' +
          '<input type="date" data-role="start" value="' + formatDateForInput(book.startDate) + '">';

        const groupEndRead = document.createElement("div");
        groupEndRead.className = "edit-dates-group";
        groupEndRead.innerHTML =
          '<label>Fin lecture</label>' +
          '<input type="date" data-role="endReading" value="' + formatDateForInput(book.endReading) + '">';

        const groupEndProc = document.createElement("div");
        groupEndProc.className = "edit-dates-group";
        groupEndProc.innerHTML =
          '<label>Fin traitement</label>' +
          '<input type="date" data-role="endProcessing" value="' + formatDateForInput(book.endProcessing) + '">';

        editDates.appendChild(groupStart);
        editDates.appendChild(groupEndRead);
        editDates.appendChild(groupEndProc);

        const editActions = document.createElement("div");
        editActions.className = "edit-actions";

        if (!isPublicMode) {
          const saveBtn = document.createElement("button");
          saveBtn.className = "button-ghost";
          saveBtn.textContent = "Enregistrer";
          saveBtn.addEventListener("click", function (ev) {
            ev.stopPropagation();
            const startVal = groupStart.querySelector("input").value;
            const endReadVal = groupEndRead.querySelector("input").value;
            const endProcVal = groupEndProc.querySelector("input").value;

            const startDate = parseDateInput(startVal);
            const endReading = parseDateInput(endReadVal);
            const endProcessing = parseDateInput(endProcVal);

            if (!startDate || !endReading || !endProcessing) {
              alert("Merci de renseigner des dates compl√®tes.");
              return;
            }
            if (endReading < startDate) {
              alert("La fin de lecture ne peut pas √™tre avant le d√©but de lecture.");
              return;
            }
            if (endProcessing < endReading) {
              alert("La fin de traitement ne peut pas √™tre avant la fin de lecture.");
              return;
            }

            book.startDate = startDate;
            book.endReading = endReading;
            book.endProcessing = endProcessing;

            renderBooks();
          });

          const todayBtn = document.createElement("button");
          todayBtn.className = "button-ghost";
          todayBtn.textContent = "Finir aujourd'hui";
          todayBtn.addEventListener("click", function (ev) {
            ev.stopPropagation();
            const today = new Date();
            const todayStr = formatDateForInput(today);
            groupEndRead.querySelector("input").value = todayStr;
            groupEndProc.querySelector("input").value = todayStr;
            book.endReading = today;
            book.endProcessing = today;
            renderBooks();
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "button-danger";
          deleteBtn.textContent = "Supprimer";
          deleteBtn.addEventListener("click", function (ev) {
            ev.stopPropagation();
            if (confirm("Supprimer ce livre du planning ?")) {
              books = books.filter((b) => b.id !== book.id);
              renderBooks();
            }
          });

          editActions.appendChild(saveBtn);
          editActions.appendChild(todayBtn);
          editActions.appendChild(deleteBtn);
        }

        editDates.appendChild(editActions);
        body.appendChild(editDates);

        row.appendChild(header);
        row.appendChild(body);
        container.appendChild(row);
      });

      updateCounters();
      renderSummaryBar();
    }

    // ----- FORMULAIRE -----
    document.getElementById("book-form").addEventListener("submit", function (e) {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const pages = Number(document.getElementById("pages").value);
      const genreSelect = document.getElementById("genre");
      const genre = genreSelect.value;
      const genreLabel = genreSelect.options[genreSelect.selectedIndex].textContent;
      const receivedDate = parseDateInput(document.getElementById("receivedDate").value);
      const startDate = parseDateInput(document.getElementById("startDate").value);

      if (!title || !pages || !receivedDate || !startDate) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      const baseDurations = computeDurationsFromPages(pages);
      const endReading = addDays(startDate, baseDurations.readingDays - 1);
      const endProcessing = addDays(endReading, baseDurations.processingDays);

      books.push({
        id: nextId++,
        title: title,
        pages: pages,
        genre: genre,
        genreLabel: genreLabel,
        receivedDate: receivedDate,
        startDate: startDate,
        endReading: endReading,
        endProcessing: endProcessing
      });

      document.getElementById("title").value = "";
      document.getElementById("pages").value = "";

      renderBooks();
    });

    // ----- EXPORT HTML -----
    function buildExportHtml() {
      const exportedBooks = books.map((b) => ({
        title: b.title,
        pages: b.pages,
        genre: b.genre,
        genreLabel: b.genreLabel,
        receivedDate: b.receivedDate.toISOString(),
        startDate: b.startDate.toISOString(),
        endReading: b.endReading.toISOString(),
        endProcessing: b.endProcessing.toISOString()
      }));

      const embedded = JSON.stringify({ books: exportedBooks }, null, 2);
      let html = document.documentElement.outerHTML;
      html = html.replace(
        "const EMBEDDED_DATA = null;",
        "const EMBEDDED_DATA = " + embedded + ";"
      );

      return "<!DOCTYPE html>\n" + html;
    }

    function exportHtmlFile() {
      if (!books.length) {
        const go = confirm(
          "Il n'y a aucun livre dans le planning. Exporter quand m√™me un index.html vide ?"
        );
        if (!go) return;
      }
      const html = buildExportHtml();
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "index.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById("export-html-btn").addEventListener("click", function () {
      exportHtmlFile();
    });

    // ----- COPIE URL PUBLIQUE -----
    function computePublicUrl() {
      if (location.protocol === "file:") {
        // En local : on affiche un message utile
        return "Ajoute ?mode=public √† ton URL GitHub Pages, par ex. :\nhttps://avertyflorian-netizen.github.io/planning-paskal/?mode=public";
      }
      let path = window.location.pathname;
      // on enl√®ve index.html si pr√©sent
      path = path.replace(/index\.html?$/i, "");
      if (!path.endsWith("/")) path += "/";
      return window.location.origin + path + "?mode=public";
    }

    document.getElementById("copy-public-url-btn").addEventListener("click", function () {
      const publicUrl = computePublicUrl();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(publicUrl)
          .then(() => {
            alert("URL publique copi√©e :\n" + publicUrl);
          })
          .catch(() => {
            prompt("Copie l‚ÄôURL publique :", publicUrl);
          });
      } else {
        prompt("Copie l‚ÄôURL publique :", publicUrl);
      }
    });

    // ----- INIT -----
    function setDefaultDates() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = yyyy + "-" + mm + "-" + dd;
      document.getElementById("receivedDate").value = todayStr;
      document.getElementById("startDate").value = todayStr;
    }

    function seedExampleBooks() {
      const today = new Date();
      function d(offset) {
        const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        t.setDate(t.getDate() + offset);
        return t;
      }

      const ex1 = {
        title: "Dark Deal ‚Äì Tome 1",
        pages: 320,
        genre: "dark_romance",
        genreLabel: "Dark romance",
        receivedDate: d(-3),
        startDate: d(-1)
      };
      const ex2 = {
        title: "Couronne de Cendres",
        pages: 540,
        genre: "romantasy",
        genreLabel: "Romantasy",
        receivedDate: d(-10),
        startDate: d(1)
      };
      const ex3 = {
        title: "La Promesse du Cartel",
        pages: 410,
        genre: "mafia_romance",
        genreLabel: "Mafia romance",
        receivedDate: d(-1),
        startDate: d(4)
      };

      [ex1, ex2, ex3].forEach((ex) => {
        const dur = computeDurationsFromPages(ex.pages);
        const endReading = addDays(ex.startDate, dur.readingDays - 1);
        const endProcessing = addDays(endReading, dur.processingDays);
        books.push({
          id: nextId++,
          title: ex.title,
          pages: ex.pages,
          genre: ex.genre,
          genreLabel: ex.genreLabel,
          receivedDate: ex.receivedDate,
          startDate: ex.startDate,
          endReading: endReading,
          endProcessing: endProcessing
        });
      });
    }

    function initModeBadge() {
      const badge = document.getElementById("mode-badge");
      const publicNotice = document.getElementById("public-notice");

      if (isPublicMode) {
        badge.innerHTML = '<span>Mode public ‚Äì lecture seule</span>';
        document.getElementById("admin-form-section").style.display = "none";
        if (publicNotice) publicNotice.style.display = "block";
      } else {
        badge.innerHTML = '<span>Mode admin ‚Äì interface compl√®te</span>';
        if (publicNotice) publicNotice.style.display = "none";
      }
    }

    function initData() {
      if (EMBEDDED_DATA && Array.isArray(EMBEDDED_DATA.books)) {
        hydrateInitialBooks(EMBEDDED_DATA.books);
      } else {
        seedExampleBooks();
      }
    }

    setDefaultDates();
    initModeBadge();
    initData();
    renderBooks();
  </script>
</body>
</html>
